## Digital Twin LLM Bot

Телеграм-бот для генерации постов на основе LLM с выбором одной из 5 моделей и автоматической ротацией API-ключей OpenRouter при исчерпании лимитов. Логика промптинга повторяет ноутбук `writer.ipynb`, но общение переносится в Telegram.

### Возможности

- **5 режимов (моделей)**: выбор через inline-кнопки в Telegram.
- **Авто-ротация API-ключей**: при 429/Quota/402 бот автоматически переключается на следующий доступный ключ.
- **Единый системный промпт**: примеры подтягиваются из Excel (`База_знаний.xlsx` по умолчанию) и подмешиваются в системный контекст.
- **Асинхронный вызов LLM**: через `langchain_openai.ChatOpenAI.ainvoke`.

### Структура

- `bot.py` — телеграм-бот (основной скрипт).
- `writer.ipynb` — исходный экспериментальный ноутбук с LLM.
- `requirements.txt` — зависимости проекта.
- `База_знаний.xlsx` — таблица с примерами (можно переопределить через переменную окружения).

### Требования

- Python 3.10+
- Аккаунт Telegram и токен бота (через BotFather)
- Ключи OpenRouter API (несколько — для ротации)

### Установка

На Windows PowerShell:

```powershell
cd D:\work\ai\digital_twin
python -m venv .venv
.venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

### Настройка окружения (.env)

Создайте файл `.env` в корне проекта:

```env
# Токен телеграм-бота
TELEGRAM_BOT_TOKEN=ваш_тг_токен

# База OpenRouter (по умолчанию подходит)
OPENROUTER_API_BASE=https://openrouter.ai/api/v1

# Вариант 1: несколько пронумерованных ключей (ротация)
OPENROUTER_API_KEY=ключ1
OPENROUTER_API_KEY2=ключ2
OPENROUTER_API_KEY3=ключ3

# Вариант 2: один список через запятую (любой формат — можно вместе с вариантом 1)
# OPENROUTER_API_KEYS=ключ1,ключ2,ключ3

# Путь к Excel с примерами для системного промпта
EXAMPLES_XLSX_PATH=База_знаний.xlsx
```

### Запуск бота

```powershell
python bot.py
```

После запуска отправьте боту `/start` в Telegram.

### Использование

- Команда **/start** — выводит приветствие и кнопки выбора моделей.
- Команда **/mode** — повторно показывает выбор режимов.
- Просто отправьте текст — бот сгенерирует пост по вашему запросу.

### Режимы (модели)

- `Qwen Coder` → `qwen/qwen3-coder:free`
- `DeepSeek R1` → `deepseek/deepseek-r1-0528:free`
- `DeepSeek Chat` → `deepseek/deepseek-chat-v3-0324:free`
- `Chimera R1T2` → `tngtech/deepseek-r1t2-chimera:free`
- `DS Distill L70B` → `deepseek/deepseek-r1-distill-llama-70b:free`

Текущий режим сохраняется на уровне чата. При желании список можно изменить в `MODELS` внутри `bot.py`.

### Авто-ротация API-ключей

При ошибках, связанных с лимитами (например, 429, 402, quota, insufficient_quota), бот:

- сообщает «Исчерпан лимит текущего ключа, переключаюсь на следующий ключ…»,
- автоматически пробует следующий ключ из указанного набора,
- продолжает обработку запроса без вашего участия.

Поддерживаются оба способа задания ключей: пронумерованные переменные `OPENROUTER_API_KEY*` и/или список `OPENROUTER_API_KEYS` (через запятую). Можно использовать их вместе.

### Кастомизация

- **Промпт**: редактируйте `PROMPT_TEMPLATE` в `bot.py`.
- **Excel с примерами**: укажите путь в `EXAMPLES_XLSX_PATH` или замените файл по умолчанию.
- **Модели и кнопки**: обновите словарь `MODELS` и/или функцию `build_modes_keyboard()`.

### Устранение неполадок

- «`TELEGRAM_BOT_TOKEN отсутствует в .env`» — проверьте `.env` и перезапустите процесс.
- «`Не найдены ключи OpenRouter`» — добавьте хотя бы один ключ в `.env` (`OPENROUTER_API_KEY*` или `OPENROUTER_API_KEYS`).
- Excel не найден — проверьте `EXAMPLES_XLSX_PATH` и существование файла на диске.
- Бот не отвечает — убедитесь, что процесс запущен, интернет есть, и токен бота корректен.
- Много 429/402 — добавьте больше ключей для ротации или уменьшите нагрузку.

### Лицензия

Данные уточняются.
